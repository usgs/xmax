package com.isti.traceview.filters;

import static asl.utils.timeseries.TimeSeriesUtils.getFirstTimeSeries;
import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

import com.isti.traceview.TraceView;
import com.isti.traceview.TraceViewException;
import com.isti.traceview.common.Configuration;
import com.isti.traceview.data.DataModule;
import com.isti.traceview.data.PlotDataProvider;
import com.isti.xmax.XMAXconfiguration;
import edu.iris.dmc.seedcodec.CodecException;
import edu.sc.seis.seisFile.mseed.SeedFormatException;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.DoubleStream;
import java.util.stream.IntStream;
import org.apache.log4j.Level;
import org.apache.log4j.LogManager;
import org.junit.Before;
import org.junit.Test;

public class FilterBPTest {

  @Test
  public void basicFilterTest() throws Exception {

    //Expected results generated using scipy's butterworth Bandpass filter
    Map<Integer, Double> expected = new HashMap<Integer, Double>() {{
      put(0, -0.0007259768062888285);
      put(11520, 964.5379296519204);
      put(23040, -829.8000146863197);
      put(34560, -50.143777108906725);
      put(46080, -263.67595368308844);
      put(57600, 184.92209861553445);
      put(69120, -418.5045925020106);
      put(80640, 383.2557372982479);
      put(92160, -608.1180130129304);
      put(103680, -445.97847502408484);
      put(115200, -907.6015526723083);
      put(126720, 324.87432603115894);
      put(138240, 100.54976813213901);
      put(149760, -179.74089677349053);
      put(161280, -1068.8853726646726);
      put(172800, -878.5080801713136);
      put(184320, -378.5930087630259);
      put(195840, -637.9916288310043);
      put(207360, -23.616330142148687);
      put(218880, -257.17730773880106);
      put(230400, -176.10904346279074);
      put(241920, -624.0273329194239);
      put(253440, 942.3344415716115);
      put(264960, -356.0489040616272);
      put(276480, 390.90468279174945);
      put(288000, 295.3804678247164);
      put(299520, -87.18581194531262);
      put(311040, 643.8277250965476);
      put(322560, 772.7379081730068);
      put(334080, 585.3416930918488);
      put(345600, -626.1844899270643);
      put(357120, 487.1897598316016);
      put(368640, -35.45698461054818);
      put(380160, 552.1646424676287);
      put(391680, -1152.9395964416642);
      put(403200, 292.9542484941901);
      put(414720, 844.7406515526121);
      put(426240, 661.3459851277631);
      put(437760, -395.4215724697204);
      put(449280, -55.918630746580355);
      put(460800, 1544.737441518784);
      put(472320, 118.09930316411617);
      put(483840, 1500.3408031157637);
      put(495360, -827.8896996386912);
      put(506880, -190.16694957973112);
      put(518400, 345.97797744463116);
      put(529920, -21.53871575141459);
      put(541440, -292.38390110368124);
      put(552960, -222.06024321310383);
      put(564480, 42.66338436982026);
      put(576000, 1356.2068199549833);
      put(587520, -923.4373532089779);
      put(599040, -442.2362524244945);
      put(610560, 721.4278975451352);
      put(622080, -536.8235244063642);
      put(633600, -89.21459077684236);
      put(645120, 281.9486688970225);
      put(656640, 107.95942920772741);
      put(668160, -340.8064346784051);
      put(679680, -701.2224482246982);
      put(691200, 173.3431576465633);
      put(702720, -451.57090426735385);
      put(714240, -101.98280980477301);
      put(725760, -491.3892493486431);
      put(737280, -119.35050564791514);
      put(748800, 649.8893006163526);
      put(760320, -342.17614115896896);
      put(771840, -381.9051786628434);
      put(783360, 724.0304479426097);
      put(794880, 300.0434761548047);
      put(806400, -74.54203871879767);
      put(817920, 245.81214424890715);
      put(829440, -29.836598924327273);
      put(840960, -332.52419154558066);
      put(852480, 1.4002047491257292);
      put(864000, -771.8211647950235);
      put(875520, 83.21822390089207);
      put(887040, 43.425962001525406);
      put(898560, 736.7267290723454);
      put(910080, 237.81446096473675);
      put(921600, 328.20349078354616);
      put(933120, -173.27870325312716);
      put(944640, -332.95655382966174);
      put(956160, -26.070321948032056);
      put(967680, 446.2847973918339);
      put(979200, 218.88358293558068);
      put(990720, -266.901212770943);
      put(1002240, -360.01553274891256);
      put(1013760, -556.2806346844009);
      put(1025280, -386.52176364872577);
      put(1036800, -241.73119656241084);
      put(1048320, -136.43697412936302);
      put(1059840, -215.6573560199677);
      put(1071360, -266.92925962531746);
      put(1082880, 320.1795392704306);
      put(1094400, -611.29055437111);
      put(1105920, -136.87840126610664);
      put(1117440, -86.46381295698677);
      put(1128960, 166.97275569608536);
      put(1140480, 262.11128454032297);
      put(1152000, -177.575117595605);
      put(1163520, 72.7683356106491);
      put(1175040, 34.8736056597163);
      put(1186560, -127.32527173536398);
      put(1198080, -112.11062868744294);
      put(1209600, 512.6860499496865);
      put(1221120, -545.9697520575226);
      put(1232640, -109.18775291996826);
      put(1244160, -196.84805279310342);
      put(1255680, -144.67189111832744);
      put(1267200, 147.81404161096168);
      put(1278720, -54.45629387521765);
      put(1290240, 266.24503991162317);
      put(1301760, 112.52362094448367);
      put(1313280, -87.88655331393295);
      put(1324800, -105.04167498202882);
      put(1336320, -76.35947792964431);
      put(1347840, -172.11939321010973);
      put(1359360, -191.14134128575606);
      put(1370880, -48.92942352181643);
      put(1382400, 226.6726398090588);
      put(1393920, -210.90445022339964);
      put(1405440, -112.76720123919607);
      put(1416960, -48.85475277465833);
      put(1428480, -144.3392982250124);
      put(1440000, -104.13836043345529);
      put(1451520, -98.14660850905666);
      put(1463040, 246.99055325083523);
      put(1474560, -320.40167741544593);
      put(1486080, -67.21722163133019);
      put(1497600, 109.46199531357806);
      put(1509120, -3.2408054330085454);
      put(1520640, 105.07276449977259);
      put(1532160, 67.0526712852674);
      put(1543680, -74.39116563295309);
      put(1555200, 225.63949227218427);
      put(1566720, 64.45590475518758);
      put(1578240, -12.075204182011749);
      put(1589760, -276.91051889850746);
      put(1601280, 19.29681058733771);
      put(1612800, -257.0987364707439);
      put(1624320, -381.5669004668581);
      put(1635840, -80.44743980517713);
      put(1647360, -170.7247746769385);
      put(1658880, 194.82866666470665);
      put(1670400, 204.8039875763818);
      put(1681920, -86.09672591224142);
      put(1693440, -18.494508134991868);
      put(1704960, 105.76889629517623);
      put(1716480, 457.9412158145034);
      put(1728000, -431.62823412099084);
      put(1739520, -525.5749673317191);
      put(1751040, 126.20158192455992);
      put(1762560, -221.59733385178012);
      put(1774080, 136.10174520624184);
      put(1785600, 34.518802875860075);
      put(1797120, -387.02539650010664);
      put(1808640, 294.2078586920092);
      put(1820160, -50.61218001723517);
      put(1831680, -179.88838790756924);
      put(1843200, 232.69935390664583);
      put(1854720, 33.17275323506709);
      put(1866240, 86.0547576659661);
      put(1877760, 44.09538134816836);
      put(1889280, -58.31149524838202);
      put(1900800, -170.31002269141828);
      put(1912320, -165.9641405522067);
      put(1923840, -48.516737465527406);
      put(1935360, -224.31772455562339);
      put(1946880, 36.200062140539714);
      put(1958400, 194.25179926310082);
      put(1969920, 120.10219009626498);
      put(1981440, 44.97126888627219);
      put(1992960, 111.57237054636144);
      put(2004480, 174.50846917420802);
      put(2016000, -160.87099196546413);
      put(2027520, -78.6486345544596);
      put(2039040, -191.85578737614745);
      put(2050560, 63.68763552095814);
      put(2062080, 119.76731050441641);
      put(2073600, 15.538239478682575);
      put(2085120, -255.74607104673458);
      put(2096640, -46.70403015075157);
      put(2108160, 48.137955215734934);
      put(2119680, 33.32174231678069);
      put(2131200, 264.87909695024945);
      put(2142720, -23.55337721446388);
      put(2154240, -24.780806149085716);
      put(2165760, -72.11188372863457);
      put(2177280, 167.2115011834622);
      put(2188800, 384.8262195297879);
      put(2200320, 189.4407096451373);
      put(2211840, 233.98949783485438);
      put(2223360, -4.93668992723988);
      put(2234880, 30.698027845456643);
      put(2246400, -96.39573775773209);
      put(2257920, 47.019427267150945);
      put(2269440, 86.67868679016698);
      put(2280960, -43.175290284401164);
      put(2292480, 38.94465852090639);
      put(2304000, -40.49871149435196);
      put(2315520, -54.98108588006115);
      put(2327040, -57.59812700303306);
      put(2338560, 19.931397599698748);
      put(2350080, 62.64817471289971);
      put(2361600, -146.6403965883225);
      put(2373120, -143.74223976468363);
      put(2384640, -50.999122677546495);
      put(2396160, 43.42689360746576);
      put(2407680, 157.49818443736905);
      put(2419200, 7.07424685390222);
      put(2430720, 101.05451547118213);
      put(2442240, -70.24197738746254);
      put(2453760, -74.32053779406652);
      put(2465280, 92.23236193813288);
      put(2476800, 98.0671215632971);
      put(2488320, 146.01035782980915);
      put(2499840, -40.60381505645652);
      put(2511360, -136.44864572680692);
      put(2522880, 34.82701655965644);
      put(2534400, 17.326672718074228);
      put(2545920, 4.158124123878134);
      put(2557440, -35.58939332869843);
      put(2568960, -128.5894675983283);
      put(2580480, -61.91867009803163);
      put(2592000, -29.351121600412213);
      put(2603520, 70.09063135946792);
      put(2615040, 119.13015373156405);
      put(2626560, -36.880627006589656);
      put(2638080, -126.02341426249644);
      put(2649600, 209.7073768158348);
      put(2661120, -112.72867527042244);
      put(2672640, -10.314488898721471);
      put(2684160, -28.017798737729674);
      put(2695680, 134.86928286381408);
      put(2707200, -75.50498178021363);
      put(2718720, -52.32025828826021);
      put(2730240, -103.17683639827086);
      put(2741760, 7.519168014534381);
      put(2753280, -107.38607823315485);
      put(2764800, -22.228718289357378);
      put(2776320, 55.177845269914705);
      put(2787840, -62.52906401796255);
      put(2799360, 189.51740708580894);
      put(2810880, 10.321527564672591);
      put(2822400, 80.9324192346134);
      put(2833920, -137.465840457863);
      put(2845440, -71.59490772040485);
      put(2856960, 82.99589429736747);
      put(2868480, 117.27895032713236);
      put(2880000, 14.116288526879611);
      put(2891520, 86.3996437567352);
      put(2903040, 5.976328861262912);
      put(2914560, -161.0959721455046);
      put(2926080, 138.04434735066218);
      put(2937600, -97.81242119644284);
      put(2949120, 42.70280505844444);
      put(2960640, 188.46782889932646);
      put(2972160, 270.2935195868465);
      put(2983680, 120.94498240844368);
      put(2995200, 235.47398201694574);
      put(3006720, -147.4949420978333);
      put(3018240, -91.09149462019154);
      put(3029760, -54.42560345140755);
      put(3041280, -70.2390485021378);
      put(3052800, -42.48354702141495);
      put(3064320, -170.8632154571594);
      put(3075840, 20.366916780470024);
      put(3087360, 126.87050472934237);
      put(3098880, -38.51676959942175);
      put(3110400, 147.7068966155165);
      put(3121920, 83.12970256154235);
      put(3133440, 60.763833482013844);
      put(3144960, 107.31469445009124);
      put(3156480, -59.81447613085753);
      put(3168000, 7.2233249852294295);
      put(3179520, 37.517308167826656);
      put(3191040, 31.58503625706166);
      put(3202560, -141.1423067851858);
      put(3214080, -33.501225325086835);
      put(3225600, 52.85402993319505);
      put(3237120, -40.43805258168288);
      put(3248640, -150.94948347986576);
      put(3260160, -114.83084671199683);
      put(3271680, -100.61340614528787);
      put(3283200, 27.533766797961658);
      put(3294720, -120.50743157911867);
      put(3306240, 72.35942225545944);
      put(3317760, -236.6024619828043);
      put(3329280, 110.80978677664424);
      put(3340800, -21.258862161788);
      put(3352320, -110.08562640220667);
      put(3363840, -150.92616698083174);
      put(3375360, 73.63364606943819);
      put(3386880, -51.627435161491796);
      put(3398400, -98.4709025815868);
      put(3409920, -5.968656416657719);
      put(3421440, -283.59049022747445);
      put(3432960, 141.03327458319637);
      put(3444480, 8.673946718043501);
    }};

    FilterBP filter = new FilterBP();
    double[] data = getFirstTimeSeries("src/test/resources/rotation/unrot_10_BHZ.512.seed").getData();
    //for (double d : IntStream.range(0, 100).mapToDouble(i -> data[i]).toArray()){
    //  System.out.println(d);
    //}
    filter.init2(40);

    double[] result = filter.filter(data, data.length);

    assertEquals(3456000, result.length);
    for (Integer key : expected.keySet()){
      //System.out.println(expected.get(key)+ ", " +result[key]);
      // Check a 12% difference
      assertTrue("Result more than 12% off", (1 - expected.get(key)/result[key]) < 0.12);
    }

    }
}